<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>改进版内嵌浏览器批量检测系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2d4059;
        }
        
        h1 {
            color: #4cc9f0;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: #a9a9a9;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            height: 75vh;
            margin-bottom: 20px;
        }
        
        .browser-container {
            flex: 3;
            background: #0f1525;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        .browser-header {
            background: #1c2541;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2d4059;
        }
        
        .browser-controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .control-btn.close { background: #ff5f57; }
        .control-btn.minimize { background: #ffbd2e; }
        .control-btn.maximize { background: #28ca42; }
        
        .browser-url {
            background: #121a2e;
            border: 1px solid #2d4059;
            border-radius: 20px;
            padding: 8px 15px;
            color: #e0e0e0;
            width: 70%;
            font-size: 0.9rem;
        }
        
        .browser-view {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .browser-frame {
            width: 100%;
            height: 100%;
            border: 1px solid #2d4059;
            border-radius: 8px;
            background: #ffffff;
            overflow: hidden;
        }
        
        .browser-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 1.2rem;
        }
        
        .browser-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .control-panel {
            flex: 1;
            background: #0f1525;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        .panel-section {
            margin-bottom: 25px;
        }
        
        .panel-title {
            color: #4cc9f0;
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2d4059;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .group-list {
            background: #121a2e;
            border-radius: 8px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .group-item {
            background: #1c2541;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            border-left: 4px solid #4cc9f0;
        }
        
        .group-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(76, 201, 240, 0.1);
        }
        
        .group-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-name {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .group-url-count {
            background: #2d4059;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .group-actions {
            display: flex;
            gap: 10px;
        }
        
        .group-btn {
            background: transparent;
            border: none;
            color: #a9a9a9;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .group-btn:hover {
            color: #4cc9f0;
        }
        
        .group-content {
            padding: 15px;
            border-top: 1px solid #2d4059;
            display: none;
        }
        
        .group-content.active {
            display: block;
        }
        
        .url-list {
            background: #0f1525;
            border-radius: 5px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .url-item {
            padding: 8px 10px;
            background: #121a2e;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .url-item:last-child {
            margin-bottom: 0;
        }
        
        .url-text {
            font-size: 0.85rem;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .url-actions {
            display: flex;
            gap: 8px;
        }
        
        .url-btn {
            background: transparent;
            border: none;
            color: #a9a9a9;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .url-btn:hover {
            color: #4cc9f0;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            background: #121a2e;
            border: 1px solid #2d4059;
            border-radius: 8px 0 0 8px;
            color: #e0e0e0;
        }
        
        .input-group button {
            padding: 12px 20px;
            background: #2d4059;
            border: 1px solid #2d4059;
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .input-group button:hover {
            background: #4cc9f0;
            color: #0f1525;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 14px;
            border-radius: 8px;
            border: none;
            background: #2d4059;
            color: #e0e0e0;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #4cc9f0;
            color: #0f1525;
            transform: translateY(-2px);
        }
        
        .action-btn.start {
            background: #28a745;
        }
        
        .action-btn.start:hover {
            background: #218838;
            color: #e0e0e0;
        }
        
        .action-btn.stop {
            background: #dc3545;
        }
        
        .action-btn.stop:hover {
            background: #c82333;
            color: #e0e0e0;
        }
        
        .status-panel {
            background: #0f1525;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        .status-title {
            color: #4cc9f0;
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2d4059;
        }
        
        .status-log {
            background: #121a2e;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #1c2541;
        }
        
        .log-time {
            color: #a9a9a9;
            margin-right: 10px;
        }
        
        .log-success { color: #28ca42; }
        .log-error { color: #ff5f57; }
        .log-info { color: #4cc9f0; }
        .log-warning { color: #ffbd2e; }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #2d4059;
            color: #a9a9a9;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #a9a9a9;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #2d4059;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .browser-container, .control-panel {
                width: 100%;
            }
            
            .browser-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-globe"></i> 改进版内嵌浏览器批量检测系统</h1>
            <p class="subtitle">多群组绑定 | 独立链接管理 | 按顺序批量测试</p>
        </header>
        
        <div class="main-content">
            <div class="browser-container">
                <div class="browser-header">
                    <div class="browser-controls">
                        <div class="control-btn close"></div>
                        <div class="control-btn minimize"></div>
                        <div class="control-btn maximize"></div>
                    </div>
                    <input type="text" class="browser-url" id="currentUrl" value="https://www.huanlegu.org/" readonly>
                    <div class="browser-actions">
                        <button id="refreshBtn" class="action-btn" style="padding: 5px 15px; font-size: 0.9rem;"><i class="fas fa-redo"></i> 刷新</button>
                    </div>
                </div>
                <div class="browser-view">
                    <div class="browser-frame" id="browserFrame">
                        <div class="browser-placeholder" id="browserPlaceholder">
                            <i class="fas fa-compass" style="color: #4cc9f0;"></i>
                            <p>浏览器就绪，点击下方按钮开始批量检测</p>
                            <p>当前URL: <span id="displayUrl">https://www.huanlegu.org/</span></p>
                            <p id="pageStatus">页面加载完成</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="panel-section">
                    <h3 class="panel-title">
                        <span><i class="fab fa-telegram"></i> Telegram群组管理</span>
                        <button id="addGroupBtn" class="action-btn" style="padding: 5px 10px; font-size: 0.8rem;"><i class="fas fa-plus"></i> 添加群组</button>
                    </h3>
                    
                    <div class="group-list" id="groupList">
                        <!-- 群组将通过JS动态生成 -->
                    </div>
                    
                    <div class="empty-state" id="noGroupsMessage" style="display: none;">
                        <i class="fas fa-users"></i>
                        <p>暂无群组，请点击"添加群组"按钮创建</p>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title"><i class="fas fa-cog"></i> 检测设置</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px;">目标Logo选择器:</label>
                        <input type="text" id="logoSelector" value=".logo, header img, .navbar-brand img" style="width: 100%; padding: 10px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="autoScreenshot" checked>
                        <label for="autoScreenshot">检测到匹配时自动截图并发送到Telegram</label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <input type="checkbox" id="sequentialTesting" checked>
                        <label for="sequentialTesting">按群组顺序批量测试</label>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="action-btn start" id="startAllBtn">
                        <i class="fas fa-play-circle"></i> 开始全部检测
                    </button>
                    <button class="action-btn" id="testSelectedBtn">
                        <i class="fas fa-vial"></i> 测试选中群组
                    </button>
                    <button class="action-btn stop" id="stopBtn" disabled>
                        <i class="fas fa-stop-circle"></i> 停止检测
                    </button>
                </div>
            </div>
        </div>
        
        <div class="status-panel">
            <h3 class="status-title"><i class="fas fa-history"></i> 操作日志</h3>
            <div class="status-log" id="statusLog">
                <div class="log-entry">
                    <span class="log-time">[16:41:09]</span>
                    <span class="log-info">系统初始化完成，等待操作...</span>
                </div>
                <div class="log-entry">
                    <span class="log-time">[16:41:11]</span>
                    <span class="log-success">已加载3个群组，共5个待检测链接</span>
                </div>
            </div>
        </div>
        
        <footer>
            <p>改进版内嵌浏览器批量检测系统 &copy; 2023 | 支持多群组独立链接管理和按顺序批量测试</p>
        </footer>
    </div>

    <!-- 添加群组模态框 -->
    <div id="groupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #0f1525; border-radius: 12px; padding: 30px; width: 500px; max-width: 90%; box-shadow: 0 15px 40px rgba(0,0,0,0.5);">
            <h3 style="color: #4cc9f0; margin-bottom: 20px; font-size: 1.5rem;"><i class="fab fa-telegram"></i> 添加新群组</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">群组名称:</label>
                <input type="text" id="modalGroupName" placeholder="例如: 测试群组" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">群组ID/用户名:</label>
                <input type="text" id="modalGroupId" placeholder="例如: @mygroup 或 -100123456789" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px;">初始URL列表 (每行一个):</label>
                <textarea id="modalGroupUrls" placeholder="https://example.com\nhttps://google.com" style="width: 100%; height: 120px; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0; resize: none;"></textarea>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button id="cancelModalBtn" class="action-btn" style="background: #6c757d; padding: 10px 20px;">取消</button>
                <button id="saveGroupBtn" class="action-btn start" style="padding: 10px 20px;">保存群组</button>
            </div>
        </div>
    </div>

    <script>
        // 群组数据结构
        const groups = [
            {
                id: 1,
                name: "测试群组",
                groupId: "@test_group",
                urls: ["https://www.huanlegu.org/", "https://example.com"],
                active: true,
                expanded: true
            },
            {
                id: 2,
                name: "监控频道",
                groupId: "@monitor_channel",
                urls: ["https://google.com", "https://github.com"],
                active: true,
                expanded: false
            },
            {
                id: 3,
                name: "VIP群组",
                groupId: "-100123456789",
                urls: ["https://stackoverflow.com"],
                active: true,
                expanded: false
            }
        ];
        
        // 全局变量
        let isRunning = false;
        let currentGroupIndex = 0;
        let currentUrlIndex = 0;
        let currentGroupId = null;
        let logEntries = [];
        
        // DOM元素
        const groupListEl = document.getElementById('groupList');
        const noGroupsMessageEl = document.getElementById('noGroupsMessage');
        const statusLogEl = document.getElementById('statusLog');
        const displayUrlEl = document.getElementById('displayUrl');
        const currentUrlEl = document.getElementById('currentUrl');
        const browserPlaceholderEl = document.getElementById('browserPlaceholder');
        const pageStatusEl = document.getElementById('pageStatus');
        const groupModalEl = document.getElementById('groupModal');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateGroupList();
            
            // 添加群组按钮事件
            document.getElementById('addGroupBtn').addEventListener('click', showGroupModal);
            
            // 模态框按钮事件
            document.getElementById('cancelModalBtn').addEventListener('click', hideGroupModal);
            document.getElementById('saveGroupBtn').addEventListener('click', saveGroup);
            
            // 开始全部检测按钮事件
            document.getElementById('startAllBtn').addEventListener('click', startAllDetection);
            
            // 测试选中群组按钮事件
            document.getElementById('testSelectedBtn').addEventListener('click', testSelectedGroup);
            
            // 停止检测按钮事件
            document.getElementById('stopBtn').addEventListener('click', stopDetection);
            
            // 刷新按钮事件
            document.getElementById('refreshBtn').addEventListener('click', refreshBrowser);
            
            // 初始化日志
            addLog("系统初始化完成，等待操作...", "info");
            addLog(`已加载${groups.length}个群组，共${getTotalUrls()}个待检测链接`, "success");
        });
        
        // 更新群组列表显示
        function updateGroupList() {
            groupListEl.innerHTML = '';
            
            if (groups.length === 0) {
                noGroupsMessageEl.style.display = 'block';
                return;
            }
            
            noGroupsMessageEl.style.display = 'none';
            
            groups.forEach((group, index) => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.innerHTML = `
                    <div class="group-header" onclick="toggleGroup(${group.id})">
                        <div class="group-info">
                            <i class="fab fa-telegram" style="color: #4cc9f0;"></i>
                            <span class="group-name">${group.name}</span>
                            <span class="group-url-count">${group.urls.length}个链接</span>
                        </div>
                        <div class="group-actions">
                            <button class="group-btn" onclick="event.stopPropagation(); editGroup(${group.id})" title="编辑群组">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="group-btn" onclick="event.stopPropagation(); deleteGroup(${group.id})" title="删除群组">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="group-content ${group.expanded ? 'active' : ''}" id="group-content-${group.id}">
                        <div style="margin-bottom: 10px; font-size: 0.9rem; color: #a9a9a9;">
                            <i class="fas fa-hashtag"></i> ${group.groupId}
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>URL列表:</span>
                                <button class="action-btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="addUrlToGroup(${group.id})">
                                    <i class="fas fa-plus"></i> 添加URL
                                </button>
                            </div>
                            <div class="url-list" id="url-list-${group.id}">
                                ${group.urls.map((url, urlIndex) => `
                                    <div class="url-item">
                                        <span class="url-text">${url}</span>
                                        <div class="url-actions">
                                            <button class="url-btn" onclick="testSingleUrl(${group.id}, ${urlIndex})" title="测试此URL">
                                                <i class="fas fa-vial"></i>
                                            </button>
                                            <button class="url-btn" onclick="removeUrlFromGroup(${group.id}, ${urlIndex})" title="删除此URL">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="action-btn" style="width: 100%; padding: 10px; font-size: 0.9rem;" onclick="startGroupDetection(${group.id})">
                            <i class="fas fa-play-circle"></i> 开始此群组检测
                        </button>
                    </div>
                `;
                groupListEl.appendChild(groupItem);
            });
        }
        
        // 显示添加群组模态框
        function showGroupModal() {
            groupModalEl.style.display = 'flex';
        }
        
        // 隐藏添加群组模态框
        function hideGroupModal() {
            groupModalEl.style.display = 'none';
            // 清空输入框
            document.getElementById('modalGroupName').value = '';
            document.getElementById('modalGroupId').value = '';
            document.getElementById('modalGroupUrls').value = '';
        }
        
        // 保存群组
        function saveGroup() {
            const name = document.getElementById('modalGroupName').value.trim();
            const groupId = document.getElementById('modalGroupId').value.trim();
            const urlsText = document.getElementById('modalGroupUrls').value.trim();
            
            if (!name || !groupId) {
                addLog("群组名称和ID不能为空", "error");
                return;
            }
            
            // 解析URL列表
            let urls = [];
            if (urlsText) {
                urls = urlsText.split('\n').map(url => url.trim()).filter(url => url && isValidUrl(url));
            }
            
            // 创建新群组
            const newGroup = {
                id: Date.now(), // 使用时间戳作为ID
                name,
                groupId,
                urls,
                active: true,
                expanded: true
            };
            
            groups.push(newGroup);
            updateGroupList();
            hideGroupModal();
            
            addLog(`已创建群组: ${name} (${urls.length}个链接)`, "success");
        }
        
        // 切换群组展开状态
        function toggleGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.expanded = !group.expanded;
                updateGroupList();
            }
        }
        
        // 编辑群组
        function editGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            // 填充模态框
            document.getElementById('modalGroupName').value = group.name;
            document.getElementById('modalGroupId').value = group.groupId;
            document.getElementById('modalGroupUrls').value = group.urls.join('\n');
            
            // 显示模态框
            groupModalEl.style.display = 'flex';
            
            // 临时保存当前编辑的群组ID
            groupModalEl.dataset.editingGroupId = groupId;
            
            // 修改保存按钮文本
            document.getElementById('saveGroupBtn').textContent = '更新群组';
            document.getElementById('saveGroupBtn').onclick = updateGroup;
        }
        
        // 更新群组
        function updateGroup() {
            const groupId = parseInt(groupModalEl.dataset.editingGroupId);
            const groupIndex = groups.findIndex(g => g.id === groupId);
            
            if (groupIndex === -1) {
                addLog("找不到要更新的群组", "error");
                return;
            }
            
            const name = document.getElementById('modalGroupName').value.trim();
            const groupIdValue = document.getElementById('modalGroupId').value.trim();
            const urlsText = document.getElementById('modalGroupUrls').value.trim();
            
            if (!name || !groupIdValue) {
                addLog("群组名称和ID不能为空", "error");
                return;
            }
            
            // 解析URL列表
            let urls = [];
            if (urlsText) {
                urls = urlsText.split('\n').map(url => url.trim()).filter(url => url && isValidUrl(url));
            }
            
            // 更新群组
            groups[groupIndex].name = name;
            groups[groupIndex].groupId = groupIdValue;
            groups[groupIndex].urls = urls;
            
            updateGroupList();
            hideGroupModal();
            
            // 恢复保存按钮
            document.getElementById('saveGroupBtn').textContent = '保存群组';
            document.getElementById('saveGroupBtn').onclick = saveGroup;
            
            addLog(`已更新群组: ${name}`, "success");
        }
        
        // 删除群组
        function deleteGroup(groupId) {
            if (!confirm("确定要删除这个群组吗？")) return;
            
            const groupIndex = groups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1) {
                const groupName = groups[groupIndex].name;
                groups.splice(groupIndex, 1);
                updateGroupList();
                addLog(`已删除群组: ${groupName}`, "warning");
            }
        }
        
        // 添加URL到群组
        function addUrlToGroup(groupId) {
            const url = prompt("请输入要添加的URL:");
            if (!url || !isValidUrl(url)) {
                addLog("无效的URL格式", "error");
                return;
            }
            
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.urls.push(url);
                updateGroupList();
                addLog(`已添加URL到群组 ${group.name}: ${url}`, "success");
            }
        }
        
        // 从群组中移除URL
        function removeUrlFromGroup(groupId, urlIndex) {
            const group = groups.find(g => g.id === groupId);
            if (group && urlIndex >= 0 && urlIndex < group.urls.length) {
                const removedUrl = group.urls[urlIndex];
                group.urls.splice(urlIndex, 1);
                updateGroupList();
                addLog(`已从群组 ${group.name} 移除URL: ${removedUrl}`, "info");
            }
        }
        
        // 开始全部检测
        function startAllDetection() {
            if (groups.length === 0) {
                addLog("没有可检测的群组", "warning");
                return;
            }
            
            isRunning = true;
            currentGroupIndex = 0;
            
            document.getElementById('startAllBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('testSelectedBtn').disabled = true;
            
            addLog(`开始全部检测，共${groups.length}个群组`, "info");
            
            // 开始处理第一个群组
            processNextGroup();
        }
        
        // 处理下一个群组
        function processNextGroup() {
            if (!isRunning || currentGroupIndex >= groups.length) {
                stopDetection();
                return;
            }
            
            const group = groups[currentGroupIndex];
            currentGroupId = group.id;
            currentUrlIndex = 0;
            
            addLog(`开始检测群组: ${group.name} (${group.urls.length}个链接)`, "info");
            
            // 开始处理当前群组的第一个URL
            processNextUrl();
        }
        
        // 处理下一个URL
        function processNextUrl() {
            const group = groups.find(g => g.id === currentGroupId);
            
            if (!isRunning || !group || currentUrlIndex >= group.urls.length) {
                // 当前群组处理完成，处理下一个群组
                currentGroupIndex++;
                if (currentGroupIndex < groups.length) {
                    setTimeout(processNextGroup, 1000);
                } else {
                    stopDetection();
                }
                return;
            }
            
            const url = group.urls[currentUrlIndex];
            addLog(`正在检测URL (${currentUrlIndex + 1}/${group.urls.length}): ${url}`, "info");
            
            // 更新浏览器显示
            displayUrlEl.textContent = url;
            currentUrlEl.value = url;
            pageStatusEl.textContent = "正在加载页面...";
            browserPlaceholderEl.innerHTML = `
                <i class="fas fa-sync fa-spin" style="color: #4cc9f0;"></i>
                <p>正在加载页面...</p>
                <p>当前URL: <span id="displayUrl">${url}</span></p>
                <p id="pageStatus">正在加载页面...</p>
            `;
            
            // 模拟检测过程
            setTimeout(() => {
                // 模拟随机检测结果
                const isMatch = Math.random() > 0.3; // 70%匹配率
                
                if (isMatch) {
                    addLog(`检测成功: URL匹配预设链接 (群组: ${group.name})`, "success");
                    
                    // 检查是否启用自动截图
                    if (document.getElementById('autoScreenshot').checked) {
                        addLog(`正在截图并发送到Telegram群组: ${group.name}`, "info");
                        simulateScreenshotAndSend(group, url);
                    }
                } else {
                    addLog(`检测失败: URL不匹配预设链接 (群组: ${group.name})`, "error");
                }
                
                // 页面加载完成
                pageStatusEl.textContent = "页面加载完成";
                browserPlaceholderEl.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28ca42;"></i>
                    <p>页面加载完成</p>
                    <p>当前URL: <span id="displayUrl">${url}</span></p>
                    <p id="pageStatus">页面加载完成</p>
                `;
                
                // 处理下一个URL
                currentUrlIndex++;
                setTimeout(processNextUrl, 1500);
            }, 2000);
        }
        
        // 开始群组检测
        function startGroupDetection(groupId) {
            const groupIndex = groups.findIndex(g => g.id === groupId);
            if (groupIndex === -1) return;
            
            const group = groups[groupIndex];
            
            if (group.urls.length === 0) {
                addLog(`群组 ${group.name} 没有可检测的URL`, "warning");
                return;
            }
            
            isRunning = true;
            currentGroupId = groupId;
            currentUrlIndex = 0;
            
            document.getElementById('startAllBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('testSelectedBtn').disabled = true;
            
            addLog(`开始检测群组: ${group.name} (${group.urls.length}个链接)`, "info");
            
            // 开始处理第一个URL
            processNextUrl();
        }
        
        // 测试选中群组
        function testSelectedGroup() {
            // 这里应该检查哪个群组被选中，为了简化，我们测试第一个展开的群组
            const expandedGroup = groups.find(g => g.expanded);
            if (!expandedGroup) {
                addLog("请先展开一个群组进行测试", "warning");
                return;
            }
            
            startGroupDetection(expandedGroup.id);
        }
        
        // 测试单个URL
        function testSingleUrl(groupId, urlIndex) {
            const group = groups.find(g => g.id === groupId);
            if (!group || urlIndex < 0 || urlIndex >= group.urls.length) return;
            
            const url = group.urls[urlIndex];
            
            addLog(`开始测试单个URL: ${url} (群组: ${group.name})`, "info");
            
            // 更新浏览器显示
            displayUrlEl.textContent = url;
            currentUrlEl.value = url;
            pageStatusEl.textContent = "正在测试页面...";
            browserPlaceholderEl.innerHTML = `
                <i class="fas fa-vial" style="color: #ffbd2e;"></i>
                <p>正在测试页面...</p>
                <p>当前URL: <span id="displayUrl">${url}</span></p>
                <p id="pageStatus">正在测试页面...</p>
            `;
            
            // 模拟测试过程
            setTimeout(() => {
                const isMatch = Math.random() > 0.5; // 50%匹配率
                
                if (isMatch) {
                    addLog(`测试成功: URL匹配预设链接 (群组: ${group.name})`, "success");
                } else {
                    addLog(`测试失败: URL不匹配预设链接 (群组: ${group.name})`, "error");
                }
                
                // 页面加载完成
                pageStatusEl.textContent = "测试完成";
                browserPlaceholderEl.innerHTML = `
                    <i class="fas fa-check-circle" style="color: ${isMatch ? '#28ca42' : '#ff5f57'}"></i>
                    <p>${isMatch ? '测试成功' : '测试失败'}</p>
                    <p>当前URL: <span id="displayUrl">${url}</span></p>
                    <p id="pageStatus">测试完成</p>
                `;
            }, 1500);
        }
        
        // 模拟截图并发送到Telegram
        function simulateScreenshotAndSend(group, url) {
            setTimeout(() => {
                addLog(`截图已发送到Telegram群组: ${group.name} (${group.groupId})`, "success");
            }, 500);
        }
        
        // 停止检测
        function stopDetection() {
            isRunning = false;
            
            document.getElementById('startAllBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('testSelectedBtn').disabled = false;
            
            const totalUrls = getTotalUrls();
            const processedUrls = getProcessedUrlsCount();
            
            if (processedUrls >= totalUrls) {
                addLog(`批量检测完成，已处理${groups.length}个群组，共${processedUrls}个URL`, "success");
            } else {
                addLog(`检测已停止，已处理${processedUrls}个URL`, "warning");
            }
            
            // 重置页面状态
            pageStatusEl.textContent = "检测已停止";
        }
        
        // 刷新浏览器
        function refreshBrowser() {
            const url = currentUrlEl.value;
            addLog("刷新浏览器: " + url, "info");
            
            // 模拟刷新效果
            pageStatusEl.textContent = "正在刷新页面...";
            browserPlaceholderEl.innerHTML = `
                <i class="fas fa-sync fa-spin" style="color: #4cc9f0;"></i>
                <p>正在刷新页面...</p>
                <p>当前URL: <span id="displayUrl">${url}</span></p>
                <p id="pageStatus">正在刷新页面...</p>
            `;
            
            setTimeout(() => {
                browserPlaceholderEl.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28ca42;"></i>
                    <p>页面刷新完成</p>
                    <p>当前URL: <span id="displayUrl">${url}</span></p>
                    <p id="pageStatus">页面刷新完成</p>
                `;
                displayUrlEl = document.getElementById('displayUrl');
                pageStatusEl = document.getElementById('pageStatus');
                addLog("页面刷新完成: " + url, "success");
            }, 1000);
        }
        
        // 添加日志
        function addLog(message, type = "info") {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let typeClass = 'log-info';
            if (type === 'success') typeClass = 'log-success';
            else if (type === 'error') typeClass = 'log-error';
            else if (type === 'warning') typeClass = 'log-warning';
            
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="${typeClass}">${message}</span>
            `;
            
            statusLogEl.appendChild(logEntry);
            statusLogEl.scrollTop = statusLogEl.scrollHeight;
            
            // 保存日志条目
            logEntries.push({time, message, type});
        }
        
        // 获取总URL数量
        function getTotalUrls() {
            return groups.reduce((total, group) => total + group.urls.length, 0);
        }
        
        // 获取已处理的URL数量
        function getProcessedUrlsCount() {
            // 简化计算，实际应该跟踪每个URL的处理状态
            return currentGroupIndex * 5 + currentUrlIndex; // 估算值
        }
        
        // 验证URL格式
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
    </script>
</body>
</html>
