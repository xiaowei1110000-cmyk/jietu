<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群组绑定网站自动化检测系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://html2canvas.hertzen.com/dist/html2canvas.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2d4059;
        }
        
        h1 {
            color: #4cc9f0;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: #a9a9a9;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            height: 80vh;
            margin-bottom: 20px;
        }
        
        .browser-container {
            flex: 3;
            background: #0f1525;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        .browser-header {
            background: #1c2541;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2d4059;
        }
        
        .browser-controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .control-btn.close { background: #ff5f57; }
        .control-btn.minimize { background: #ffbd2e; }
        .control-btn.maximize { background: #28ca42; }
        
        .browser-url {
            background: #121a2e;
            border: 1px solid #2d4059;
            border-radius: 20px;
            padding: 8px 15px;
            color: #e0e0e0;
            width: 70%;
            font-size: 0.9rem;
        }
        
        .browser-view {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .browser-frame {
            width: 100%;
            height: 100%;
            border: 1px solid #2d4059;
            border-radius: 8px;
            background: #ffffff;
            overflow: hidden;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        
        .control-panel {
            flex: 1;
            background: #0f1525;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        .panel-section {
            margin-bottom: 25px;
        }
        
        .panel-title {
            color: #4cc9f0;
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2d4059;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .group-list {
            background: #121a2e;
            border-radius: 8px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .group-item {
            background: #1c2541;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            border-left: 4px solid #4cc9f0;
        }
        
        .group-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(76, 201, 240, 0.1);
        }
        
        .group-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-name {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .group-url-count {
            background: #2d4059;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .group-actions {
            display: flex;
            gap: 10px;
        }
        
        .group-btn {
            background: transparent;
            border: none;
            color: #a9a9a9;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .group-btn:hover {
            color: #4cc9f0;
        }
        
        .group-content {
            padding: 15px;
            border-top: 1px solid #2d4059;
            display: none;
        }
        
        .group-content.active {
            display: block;
        }
        
        .url-list {
            background: #0f1525;
            border-radius: 5px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .url-item {
            padding: 8px 10px;
            background: #121a2e;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .url-item:last-child {
            margin-bottom: 0;
        }
        
        .url-text {
            font-size: 0.85rem;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .url-actions {
            display: flex;
            gap: 8px;
        }
        
        .url-btn {
            background: transparent;
            border: none;
            color: #a9a9a9;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .url-btn:hover {
            color: #4cc9f0;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 15px;
        }
        
        .input-group input, .input-group textarea, .input-group select {
            flex: 1;
            padding: 12px 15px;
            background: #121a2e;
            border: 1px solid #2d4059;
            border-radius: 8px 0 0 8px;
            color: #e0e0e0;
        }
        
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .input-group button {
            padding: 12px 20px;
            background: #2d4059;
            border: 1px solid #2d4059;
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .input-group button:hover {
            background: #4cc9f0;
            color: #0f1525;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 14px;
            border-radius: 8px;
            border: none;
            background: #2d4059;
            color: #e0e0e0;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #4cc9f0;
            color: #0f1525;
            transform: translateY(-2px);
        }
        
        .action-btn.start {
            background: #28a745;
        }
        
        .action-btn.start:hover {
            background: #218838;
            color: #e0e0e0;
        }
        
        .action-btn.stop {
            background: #dc3545;
        }
        
        .action-btn.stop:hover {
            background: #c82333;
            color: #e0e0e0;
        }
        
        .status-panel {
            background: #0f1525;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        .status-title {
            color: #4cc9f0;
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2d4059;
        }
        
        .status-log {
            background: #121a2e;
            border-radius: 8px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #1c2541;
        }
        
        .log-time {
            color: #a9a9a9;
            margin-right: 10px;
        }
        
        .log-success { color: #28ca42; }
        .log-error { color: #ff5f57; }
        .log-info { color: #4cc9f0; }
        .log-warning { color: #ffbd2e; }
        
        .dynamic-links-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #2d4059;
        }
        
        .links-input-area {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #121a2e;
            border: 1px solid #2d4059;
            border-radius: 8px;
            color: #e0e0e0;
            resize: vertical;
            font-family: monospace;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .links-input-area::placeholder {
            color: #666;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #2d4059;
            color: #a9a9a9;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #a9a9a9;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #2d4059;
        }
        
        .config-section {
            background: #121a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .config-section h4 {
            color: #4cc9f0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .screenshot-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            border-radius: 10px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            display: none;
        }
        
        .screenshot-preview img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 5px;
        }
        
        .screenshot-preview .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5f57;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .browser-container, .control-panel {
                width: 100%;
            }
            
            .browser-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> 群组绑定网站自动化检测系统</h1>
            <p class="subtitle">每个群组独立绑定网站 | 自动点击Logo验证 | 截图发送到Telegram</p>
        </header>
        
        <div class="main-content">
            <div class="browser-container">
                <div class="browser-header">
                    <div class="browser-controls">
                        <div class="control-btn close"></div>
                        <div class="control-btn minimize"></div>
                        <div class="control-btn maximize"></div>
                    </div>
                    <input type="text" class="browser-url" id="currentUrl" value="https://www.baidu.com/" readonly>
                    <div class="browser-actions">
                        <button id="refreshBtn" class="action-btn" style="padding: 5px 15px; font-size: 0.9rem;"><i class="fas fa-redo"></i> 刷新</button>
                        <button id="testScreenshotBtn" class="action-btn" style="padding: 5px 15px; font-size: 0.9rem; background: #6f42c1;">
                            <i class="fas fa-camera"></i> 测试截图
                        </button>
                    </div>
                </div>
                <div class="browser-view">
                    <div class="browser-frame">
                        <iframe id="browserIframe" src="https://www.baidu.com" sandbox="allow-same-origin allow-scripts allow-forms" allow="autoplay; camera; microphone; geolocation"></iframe>
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="panel-section">
                    <h3 class="panel-title">
                        <span><i class="fab fa-telegram"></i> Telegram机器人配置</span>
                        <button id="testBotBtn" class="action-btn" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-vial"></i> 测试机器人
                        </button>
                    </h3>
                    
                    <div class="config-section">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Bot Token:</label>
                            <input type="text" id="botToken" value="YOUR_BOT_TOKEN_HERE" placeholder="Telegram Bot Token" style="width: 100%; padding: 10px; background: #0f1525; border: 1px solid #2d4059; border-radius: 5px; color: #e0e0e0;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="autoScreenshot" checked>
                                <label for="autoScreenshot" style="font-size: 0.9rem;">自动截图并发送到群组</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="sequentialTesting" checked>
                                <label for="sequentialTesting" style="font-size: 0.9rem;">顺序批量测试</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title">
                        <span><i class="fas fa-users"></i> 群组管理</span>
                        <button id="addGroupBtn" class="action-btn" style="padding: 5px 10px; font-size: 0.8rem;"><i class="fas fa-plus"></i> 添加群组</button>
                    </h3>
                    
                    <div class="group-list" id="groupList">
                        <!-- 群组将通过JS动态生成 -->
                    </div>
                    
                    <div class="empty-state" id="noGroupsMessage" style="display: none;">
                        <i class="fas fa-users"></i>
                        <p>暂无群组，请点击"添加群组"按钮创建</p>
                    </div>
                </div>
                
                <div class="dynamic-links-section">
                    <h3 class="panel-title"><i class="fas fa-link"></i> 检测链接输入</h3>
                    <p style="margin-bottom: 10px; color: #a9a9a9; font-size: 0.9rem;">输入要检测的链接，系统会根据CID自动分配到对应群组</p>
                    <textarea class="links-input-area" id="dynamicLinksInput" placeholder="在此输入要检测的链接，每行一个URL，例如：
https://example.com/page?cid=12345
https://example.com/page?cid=67890
https://example.com/page?cid=abcde"></textarea>
                    <div style="display: flex; gap: 10px;">
                        <button class="action-btn" id="parseLinksBtn" style="flex: 2;">
                            <i class="fas fa-code-branch"></i> 解析链接并分配
                        </button>
                        <button class="action-btn" id="clearLinksBtn" style="flex: 1; background: #6c757d;">
                            <i class="fas fa-trash"></i> 清空
                        </button>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="action-btn start" id="startAllBtn">
                        <i class="fas fa-play-circle"></i> 开始全部检测
                    </button>
                    <button class="action-btn" id="testSelectedBtn">
                        <i class="fas fa-vial"></i> 测试选中群组
                    </button>
                    <button class="action-btn" id="testSendBtn" style="background: #6f42c1;">
                        <i class="fas fa-paper-plane"></i> 测试发送图片
                    </button>
                    <button class="action-btn stop" id="stopBtn" disabled>
                        <i class="fas fa-stop-circle"></i> 停止检测
                    </button>
                </div>
            </div>
        </div>
        
        <div class="status-panel">
            <h3 class="status-title"><i class="fas fa-history"></i> 操作日志</h3>
            <div class="status-log" id="statusLog">
                <div class="log-entry">
                    <span class="log-time">[16:41:09]</span>
                    <span class="log-info">系统初始化完成，等待操作...</span>
                </div>
                <div class="log-entry">
                    <span class="log-time">[16:41:11]</span>
                    <span class="log-success">已加载3个群组，当前没有待检测链接</span>
                </div>
            </div>
        </div>
        
        <footer>
            <p>群组绑定网站自动化检测系统 &copy; 2023 | 每个群组独立绑定网站，自动点击Logo验证URL一致性</p>
        </footer>
    </div>

    <!-- 截图预览 -->
    <div class="screenshot-preview" id="screenshotPreview">
        <button class="close-btn" onclick="closeScreenshotPreview()">×</button>
        <h4 style="color: #4cc9f0; margin-bottom: 10px;">截图预览</h4>
        <div id="screenshotImageContainer"></div>
        <div style="margin-top: 15px; text-align: center;">
            <button class="action-btn" onclick="sendTestScreenshot()" style="background: #28a745;">
                <i class="fab fa-telegram"></i> 发送到测试群组
            </button>
        </div>
    </div>

    <!-- 添加群组模态框 -->
    <div id="groupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #0f1525; border-radius: 12px; padding: 30px; width: 600px; max-width: 90%; box-shadow: 0 15px 40px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;">
            <h3 style="color: #4cc9f0; margin-bottom: 20px; font-size: 1.5rem;"><i class="fas fa-users"></i> 添加/编辑群组</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">群组名称:</label>
                <input type="text" id="modalGroupName" placeholder="例如: 测试群组" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">群组CID (唯一标识符):</label>
                <input type="text" id="modalGroupCid" placeholder="例如: 12345 或 user67890" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
                <small style="color: #a9a9a9; display: block; margin-top: 5px;">用于匹配URL中的CID参数值</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Telegram群组ID:</label>
                <input type="text" id="modalGroupId" placeholder="例如: -100123456789" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
                <small style="color: #a9a9a9; display: block; margin-top: 5px;">必须是以 -100 开头的群组ID</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">绑定网站URL:</label>
                <input type="text" id="modalGroupWebsite" placeholder="例如: https://www.example.com" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
                <small style="color: #a9a9a9; display: block; margin-top: 5px;">该群组要检测的网站地址</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Logo选择器 (CSS):</label>
                <input type="text" id="modalGroupLogoSelector" placeholder="例如: .logo, header img, .navbar-brand img" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
                <small style="color: #a9a9a9; display: block; margin-top: 5px;">用于在该网站查找Logo的CSS选择器</small>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px;">CID参数名 (可选):</label>
                <input type="text" id="modalGroupCidParam" placeholder="例如: cid, id, userid" style="width: 100%; padding: 12px; background: #121a2e; border: 1px solid #2d4059; border-radius: 8px; color: #e0e0e0;">
                <small style="color: #a9a9a9; display: block; margin-top: 5px;">如果为空，使用全局CID参数名</small>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button id="cancelModalBtn" class="action-btn" style="background: #6c757d; padding: 10px 20px;">取消</button>
                <button id="saveGroupBtn" class="action-btn start" style="padding: 10px 20px;">保存群组</button>
            </div>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // 群组数据结构 - 每个群组独立绑定网站
        const groups = [
            {
                id: 1,
                name: "测试群组 A",
                groupId: "-100123456789",
                cid: "12345",
                website: "https://www.baidu.com",
                logoSelector: ".logo, #lg img, .s-img",
                cidParam: "cid",
                urls: [],
                active: true,
                expanded: true
            },
            {
                id: 2,
                name: "测试群组 B",
                groupId: "-100987654321",
                cid: "67890",
                website: "https://www.google.com",
                logoSelector: ".lnXdpd, #hplogo img, .logo",
                cidParam: "cid",
                urls: [],
                active: true,
                expanded: false
            },
            {
                id: 3,
                name: "VIP群组",
                groupId: "-100111111111",
                cid: "abcde",
                website: "https://github.com",
                logoSelector: ".header-logo-invertocat, .octicon-mark-github",
                cidParam: "cid",
                urls: [],
                active: true,
                expanded: false
            }
        ];
        
        // 全局变量
        let isRunning = false;
        let currentGroupIndex = 0;
        let currentUrlIndex = 0;
        let currentGroupId = null;
        let logEntries = [];
        let dynamicLinks = [];
        let botToken = "";
        let currentScreenshot = null;
        
        // DOM元素
        const groupListEl = document.getElementById('groupList');
        const noGroupsMessageEl = document.getElementById('noGroupsMessage');
        const statusLogEl = document.getElementById('statusLog');
        const currentUrlEl = document.getElementById('currentUrl');
        const browserIframe = document.getElementById('browserIframe');
        const dynamicLinksInput = document.getElementById('dynamicLinksInput');
        const groupModalEl = document.getElementById('groupModal');
        const screenshotPreview = document.getElementById('screenshotPreview');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateGroupList();
            loadConfig();
            
            // 绑定事件
            document.getElementById('addGroupBtn').addEventListener('click', showGroupModal);
            document.getElementById('cancelModalBtn').addEventListener('click', hideGroupModal);
            document.getElementById('saveGroupBtn').addEventListener('click', saveGroup);
            document.getElementById('startAllBtn').addEventListener('click', startAllDetection);
            document.getElementById('testSelectedBtn').addEventListener('click', testSelectedGroup);
            document.getElementById('stopBtn').addEventListener('click', stopDetection);
            document.getElementById('refreshBtn').addEventListener('click', refreshBrowser);
            document.getElementById('parseLinksBtn').addEventListener('click', parseDynamicLinks);
            document.getElementById('clearLinksBtn').addEventListener('click', clearDynamicLinks);
            document.getElementById('testBotBtn').addEventListener('click', testBotConnection);
            document.getElementById('testScreenshotBtn').addEventListener('click', takeScreenshot);
            document.getElementById('testSendBtn').addEventListener('click', testSendScreenshot);
            
            // 监听配置变化
            document.getElementById('botToken').addEventListener('change', saveConfig);
            document.getElementById('autoScreenshot').addEventListener('change', saveConfig);
            document.getElementById('sequentialTesting').addEventListener('change', saveConfig);
            
            addLog("系统初始化完成，等待操作...", "info");
            addLog(`已加载${groups.length}个群组，每个群组已绑定独立网站`, "success");
        });
        
        // 加载配置
        function loadConfig() {
            const savedConfig = localStorage.getItem('groupDetectionConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('botToken').value = config.botToken || 'YOUR_BOT_TOKEN_HERE';
                    document.getElementById('autoScreenshot').checked = config.autoScreenshot !== false;
                    document.getElementById('sequentialTesting').checked = config.sequentialTesting !== false;
                    botToken = config.botToken || '';
                    
                    // 加载群组数据
                    if (config.groups && config.groups.length > 0) {
                        groups.length = 0;
                        config.groups.forEach(group => groups.push(group));
                        updateGroupList();
                    }
                } catch (e) {
                    console.error('加载配置失败:', e);
                }
            }
        }
        
        // 保存配置
        function saveConfig() {
            const config = {
                botToken: document.getElementById('botToken').value,
                autoScreenshot: document.getElementById('autoScreenshot').checked,
                sequentialTesting: document.getElementById('sequentialTesting').checked,
                groups: groups,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('groupDetectionConfig', JSON.stringify(config));
            botToken = config.botToken;
            addLog("配置已保存", "info");
        }
        
        // 更新群组列表显示
        function updateGroupList() {
            groupListEl.innerHTML = '';
            
            if (groups.length === 0) {
                noGroupsMessageEl.style.display = 'block';
                return;
            }
            
            noGroupsMessageEl.style.display = 'none';
            
            groups.forEach((group, index) => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.innerHTML = `
                    <div class="group-header" onclick="toggleGroup(${group.id})">
                        <div class="group-info">
                            <i class="fab fa-telegram" style="color: #4cc9f0;"></i>
                            <span class="group-name">${group.name}</span>
                            <span class="group-url-count">${group.urls.length}个链接</span>
                        </div>
                        <div class="group-actions">
                            <button class="group-btn" onclick="event.stopPropagation(); editGroup(${group.id})" title="编辑群组">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="group-btn" onclick="event.stopPropagation(); deleteGroup(${group.id})" title="删除群组">
                                <i class="fas fa-trash"></i>
                            </button>
                            ${group.urls.length > 0 ? `
                                <button class="group-btn" onclick="event.stopPropagation(); testGroup(${group.id})" title="测试此群组">
                                    <i class="fas fa-vial"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="group-content ${group.expanded ? 'active' : ''}" id="group-content-${group.id}">
                        <div style="margin-bottom: 10px; font-size: 0.9rem; color: #a9a9a9;">
                            <div><i class="fas fa-hashtag"></i> CID: ${group.cid}</div>
                            <div><i class="fab fa-telegram"></i> 群组ID: ${group.groupId}</div>
                            <div><i class="fas fa-globe"></i> 绑定网站: ${getShortUrl(group.website)}</div>
                            <div><i class="fas fa-crosshairs"></i> Logo选择器: ${group.logoSelector.substring(0, 30)}${group.logoSelector.length > 30 ? '...' : ''}</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>待检测链接 (${group.urls.length}个):</span>
                                ${group.urls.length > 0 ? `
                                    <button class="action-btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="startGroupDetection(${group.id})">
                                        <i class="fas fa-play-circle"></i> 开始检测
                                    </button>
                                ` : ''}
                            </div>
                            ${group.urls.length > 0 ? `
                                <div class="url-list" id="url-list-${group.id}">
                                    ${group.urls.map((url, urlIndex) => `
                                        <div class="url-item">
                                            <span class="url-text">${getShortUrl(url)}</span>
                                            <div class="url-actions">
                                                <button class="url-btn" onclick="testSingleUrl(${group.id}, ${urlIndex})" title="测试此URL">
                                                    <i class="fas fa-vial"></i>
                                                </button>
                                                <button class="url-btn" onclick="removeUrlFromGroup(${group.id}, ${urlIndex})" title="删除此URL">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 15px; background: #121a2e; border-radius: 5px; color: #666;">
                                    <i class="fas fa-link"></i> 暂无链接，请在上方输入链接并解析
                                </div>
                            `}
                        </div>
                    </div>
                `;
                groupListEl.appendChild(groupItem);
            });
        }
        
        // 显示添加群组模态框
        function showGroupModal() {
            groupModalEl.style.display = 'flex';
        }
        
        // 隐藏添加群组模态框
        function hideGroupModal() {
            groupModalEl.style.display = 'none';
            document.getElementById('modalGroupName').value = '';
            document.getElementById('modalGroupCid').value = '';
            document.getElementById('modalGroupId').value = '';
            document.getElementById('modalGroupWebsite').value = '';
            document.getElementById('modalGroupLogoSelector').value = '';
            document.getElementById('modalGroupCidParam').value = '';
            document.getElementById('saveGroupBtn').textContent = '保存群组';
            delete groupModalEl.dataset.editingGroupId;
        }
        
        // 保存群组
        function saveGroup() {
            const name = document.getElementById('modalGroupName').value.trim();
            const cid = document.getElementById('modalGroupCid').value.trim();
            const groupId = document.getElementById('modalGroupId').value.trim();
            const website = document.getElementById('modalGroupWebsite').value.trim();
            const logoSelector = document.getElementById('modalGroupLogoSelector').value.trim();
            const cidParam = document.getElementById('modalGroupCidParam').value.trim();
            
            if (!name || !cid || !groupId || !website || !logoSelector) {
                addLog("请填写所有必填字段", "error");
                return;
            }
            
            if (!groupId.startsWith('-100')) {
                addLog("Telegram群组ID必须以 -100 开头", "error");
                return;
            }
            
            if (!isValidUrl(website)) {
                addLog("请输入有效的网站URL", "error");
                return;
            }
            
            const editingGroupId = parseInt(groupModalEl.dataset.editingGroupId || 0);
            if (editingGroupId) {
                // 更新现有群组
                const groupIndex = groups.findIndex(g => g.id === editingGroupId);
                if (groupIndex !== -1) {
                    groups[groupIndex].name = name;
                    groups[groupIndex].cid = cid;
                    groups[groupIndex].groupId = groupId;
                    groups[groupIndex].website = website;
                    groups[groupIndex].logoSelector = logoSelector;
                    groups[groupIndex].cidParam = cidParam || 'cid';
                    addLog(`已更新群组: ${name}`, "success");
                }
            } else {
                // 检查CID是否已存在
                if (groups.some(g => g.cid === cid)) {
                    addLog(`CID "${cid}" 已存在，请使用不同的CID值`, "error");
                    return;
                }
                
                // 创建新群组
                const newGroup = {
                    id: Date.now(),
                    name,
                    groupId,
                    cid,
                    website,
                    logoSelector,
                    cidParam: cidParam || 'cid',
                    urls: [],
                    active: true,
                    expanded: true
                };
                
                groups.push(newGroup);
                addLog(`已创建群组: ${name}`, "success");
            }
            
            updateGroupList();
            saveConfig();
            hideGroupModal();
        }
        
        // 编辑群组
        function editGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            document.getElementById('modalGroupName').value = group.name;
            document.getElementById('modalGroupCid').value = group.cid;
            document.getElementById('modalGroupId').value = group.groupId;
            document.getElementById('modalGroupWebsite').value = group.website;
            document.getElementById('modalGroupLogoSelector').value = group.logoSelector;
            document.getElementById('modalGroupCidParam').value = group.cidParam || 'cid';
            
            groupModalEl.dataset.editingGroupId = groupId;
            document.getElementById('saveGroupBtn').textContent = '更新群组';
            groupModalEl.style.display = 'flex';
        }
        
        // 删除群组
        function deleteGroup(groupId) {
            if (!confirm("确定要删除这个群组吗？")) return;
            
            const groupIndex = groups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1) {
                const groupName = groups[groupIndex].name;
                groups.splice(groupIndex, 1);
                updateGroupList();
                saveConfig();
                addLog(`已删除群组: ${groupName}`, "warning");
            }
        }
        
        // 切换群组展开状态
        function toggleGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.expanded = !group.expanded;
                updateGroupList();
            }
        }
        
        // 从群组中移除URL
        function removeUrlFromGroup(groupId, urlIndex) {
            const group = groups.find(g => g.id === groupId);
            if (group && urlIndex >= 0 && urlIndex < group.urls.length) {
                const removedUrl = group.urls[urlIndex];
                group.urls.splice(urlIndex, 1);
                updateGroupList();
                addLog(`已从群组 ${group.name} 移除URL: ${getShortUrl(removedUrl)}`, "info");
            }
        }
        
        // 测试群组
        function testGroup(groupId) {
            startGroupDetection(groupId);
        }
        
        // 解析动态链接并分配群组
        function parseDynamicLinks() {
            const linksText = dynamicLinksInput.value.trim();
            if (!linksText) {
                addLog("请输入要解析的链接", "warning");
                return;
            }
            
            // 清空所有群组中的URL
            groups.forEach(group => group.urls = []);
            
            // 解析链接
            const links = linksText.split('\n')
                .map(link => link.trim())
                .filter(link => link && isValidUrl(link));
            
            if (links.length === 0) {
                addLog("未找到有效的URL链接", "error");
                return;
            }
            
            dynamicLinks = links;
            
            // 为每个链接分配群组
            let matchedCount = 0;
            
            links.forEach(link => {
                let matchedGroup = null;
                
                // 尝试从每个群组的CID参数名中提取CID
                for (const group of groups) {
                    const cidParam = group.cidParam || 'cid';
                    const cidValue = extractParamFromUrl(link, cidParam);
                    if (cidValue && group.cid === cidValue) {
                        matchedGroup = group;
                        break;
                    }
                }
                
                if (matchedGroup) {
                    matchedGroup.urls.push(link);
                    matchedCount++;
                    addLog(`链接分配成功: ${getShortUrl(link)} → ${matchedGroup.name}`, "success");
                } else {
                    addLog(`链接分配失败: ${getShortUrl(link)} 未匹配到任何群组`, "warning");
                }
            });
            
            updateGroupList();
            
            if (matchedCount > 0) {
                addLog(`解析完成! ${links.length}个链接中，${matchedCount}个已成功分配群组`, "success");
            } else {
                addLog(`解析完成，但未找到任何匹配CID的链接`, "warning");
            }
        }
        
        // 清空动态链接
        function clearDynamicLinks() {
            dynamicLinksInput.value = '';
            groups.forEach(group => group.urls = []);
            updateGroupList();
            addLog("已清空所有链接", "info");
        }
        
        // 开始全部检测
        function startAllDetection() {
            // 检查是否有链接
            const totalUrls = getTotalUrls();
            if (totalUrls === 0) {
                addLog("没有待检测的链接，请先输入链接并解析", "warning");
                return;
            }
            
            isRunning = true;
            currentGroupIndex = 0;
            
            document.getElementById('startAllBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('testSelectedBtn').disabled = true;
            document.getElementById('testSendBtn').disabled = true;
            
            addLog(`开始全部检测，共${getGroupsWithUrls()}个群组，${totalUrls}个链接`, "info");
            
            processNextGroup();
        }
        
        // 处理下一个群组
        function processNextGroup() {
            if (!isRunning) return;
            
            // 寻找下一个有URL的群组
            while (currentGroupIndex < groups.length && groups[currentGroupIndex].urls.length === 0) {
                currentGroupIndex++;
            }
            
            if (currentGroupIndex >= groups.length) {
                stopDetection();
                addLog("批量检测完成，所有群组已处理完毕", "success");
                return;
            }
            
            const group = groups[currentGroupIndex];
            currentGroupId = group.id;
            currentUrlIndex = 0;
            
            addLog(`开始检测群组: ${group.name} (绑定网站: ${getShortUrl(group.website)})`, "info");
            
            // 加载群组绑定的网站
            loadUrlInIframe(group.website);
            
            // 等待页面加载后开始检测
            setTimeout(() => {
                processNextUrl();
            }, 3000);
        }
        
        // 处理下一个URL
        function processNextUrl() {
            const group = groups.find(g => g.id === currentGroupId);
            
            if (!isRunning || !group) {
                return;
            }
            
            if (currentUrlIndex >= group.urls.length) {
                // 当前群组处理完成，处理下一个群组
                currentGroupIndex++;
                setTimeout(processNextGroup, 1000);
                return;
            }
            
            const targetUrl = group.urls[currentUrlIndex];
            addLog(`正在检测 (${currentUrlIndex + 1}/${group.urls.length}): ${getShortUrl(targetUrl)}`, "info");
            
            // 在群组绑定的网站上查找并点击Logo
            setTimeout(() => {
                findAndClickLogo(group, targetUrl);
            }, 1000);
        }
        
        // 在iframe中查找并点击Logo
        async function findAndClickLogo(group, targetUrl) {
            try {
                const iframeDoc = browserIframe.contentDocument || browserIframe.contentWindow.document;
                const logoSelector = group.logoSelector;
                
                // 尝试多种选择器
                const selectors = logoSelector.split(',').map(s => s.trim()).filter(s => s);
                
                let logoElement = null;
                let foundSelector = '';
                
                for (const selector of selectors) {
                    try {
                        const elements = iframeDoc.querySelectorAll(selector);
                        if (elements.length > 0) {
                            logoElement = elements[0];
                            foundSelector = selector;
                            break;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                if (logoElement) {
                    addLog(`找到Logo元素: ${foundSelector}`, "success");
                    
                    try {
                        // 点击Logo
                        logoElement.click();
                        addLog(`已点击Logo，等待页面跳转...`, "info");
                        
                        // 等待跳转
                        setTimeout(async () => {
                            await checkPageAfterClick(group, targetUrl);
                        }, 2000);
                        
                    } catch (clickError) {
                        addLog(`点击Logo时出错: ${clickError.message}`, "error");
                        currentUrlIndex++;
                        setTimeout(processNextUrl, 1000);
                    }
                } else {
                    addLog(`未找到Logo元素 (选择器: ${logoSelector})`, "error");
                    currentUrlIndex++;
                    setTimeout(processNextUrl, 1000);
                }
            } catch (error) {
                addLog(`查找Logo时出错: ${error.message}`, "error");
                currentUrlIndex++;
                setTimeout(processNextUrl, 1000);
            }
        }
        
        // 检查点击后的页面
        async function checkPageAfterClick(group, targetUrl) {
            try {
                const currentIframeUrl = browserIframe.contentWindow.location.href;
                
                addLog(`点击后页面: ${getShortUrl(currentIframeUrl)}`, "info");
                addLog(`目标页面: ${getShortUrl(targetUrl)}`, "info");
                
                // 检查URL是否匹配
                const isMatch = urlsAreEquivalent(currentIframeUrl, targetUrl);
                
                if (isMatch) {
                    addLog(`✓ 检测成功: 页面URL匹配 (群组: ${group.name})`, "success");
                    
                    // 如果启用了自动截图，截图并发送
                    if (document.getElementById('autoScreenshot').checked) {
                        await takeAndSendScreenshot(group, targetUrl);
                    }
                } else {
                    addLog(`✗ 检测失败: 页面URL不匹配 (群组: ${group.name})`, "error");
                }
                
                // 处理下一个URL
                currentUrlIndex++;
                setTimeout(processNextUrl, 2000);
                
            } catch (error) {
                addLog(`检查页面时出错: ${error.message}`, "error");
                currentUrlIndex++;
                setTimeout(processNextUrl, 1000);
            }
        }
        
        // 截图并发送到Telegram
        async function takeAndSendScreenshot(group, url) {
            try {
                addLog(`正在截图并发送到群组: ${group.name}...`, "info");
                
                // 获取当前iframe的canvas
                const iframeDoc = browserIframe.contentDocument || browserIframe.contentWindow.document;
                
                // 使用html2canvas截图
                const canvas = await html2canvas(iframeDoc.body, {
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    scale: 0.8
                });
                
                // 转换为DataURL
                const screenshotDataUrl = canvas.toDataURL('image/png');
                currentScreenshot = screenshotDataUrl;
                
                // 模拟发送到Telegram（实际使用时需要后端支持）
                const isSuccess = await simulateSendToTelegram(group.groupId, screenshotDataUrl, `检测成功: ${url}`);
                
                if (isSuccess) {
                    addLog(`✓ 截图已发送到群组: ${group.name}`, "success");
                } else {
                    addLog(`✗ 截图发送失败: ${group.name}`, "error");
                }
                
            } catch (error) {
                addLog(`截图时出错: ${error.message}`, "error");
            }
        }
        
        // 测试发送截图
        async function testSendScreenshot() {
            const group = groups.find(g => g.expanded) || groups[0];
            if (!group) {
                addLog("没有可用的群组进行测试", "warning");
                return;
            }
            
            if (!botToken || botToken === 'YOUR_BOT_TOKEN_HERE') {
                addLog("请先设置有效的Bot Token", "error");
                return;
            }
            
            addLog(`正在测试发送截图到群组: ${group.name}...`, "info");
            
            // 先截图
            await takeScreenshot();
            
            if (currentScreenshot) {
                // 模拟发送
                const isSuccess = await simulateSendToTelegram(group.groupId, currentScreenshot, `测试截图 - ${new Date().toLocaleString()}`);
                
                if (isSuccess) {
                    addLog(`✓ 测试截图已发送到群组: ${group.name}`, "success");
                } else {
                    addLog(`✗ 测试截图发送失败`, "error");
                }
            }
        }
        
        // 截图当前页面
        async function takeScreenshot() {
            try {
                addLog("正在截图...", "info");
                
                const iframeDoc = browserIframe.contentDocument || browserIframe.contentWindow.document;
                
                const canvas = await html2canvas(iframeDoc.body, {
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    scale: 0.7
                });
                
                currentScreenshot = canvas.toDataURL('image/png');
                
                // 显示预览
                document.getElementById('screenshotImageContainer').innerHTML = `
                    <img src="${currentScreenshot}" alt="截图预览">
                `;
                screenshotPreview.style.display = 'block';
                
                addLog("截图完成，可预览并发送", "success");
                
            } catch (error) {
                addLog(`截图失败: ${error.message}`, "error");
            }
        }
        
        // 关闭截图预览
        function closeScreenshotPreview() {
            screenshotPreview.style.display = 'none';
        }
        
        // 发送测试截图
        async function sendTestScreenshot() {
            if (!currentScreenshot) {
                addLog("请先截图", "warning");
                return;
            }
            
            const group = groups[0]; // 使用第一个群组测试
            const isSuccess = await simulateSendToTelegram(group.groupId, currentScreenshot, "测试截图");
            
            if (isSuccess) {
                addLog("测试截图已发送", "success");
                closeScreenshotPreview();
            } else {
                addLog("测试截图发送失败", "error");
            }
        }
        
        // 模拟发送到Telegram（实际使用时需要后端API）
        async function simulateSendToTelegram(chatId, imageDataUrl, caption) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // 模拟成功（实际应该调用Telegram Bot API）
                    const success = Math.random() > 0.2; // 80%成功率
                    
                    if (success) {
                        console.log(`模拟发送到Telegram: chatId=${chatId}, caption=${caption}`);
                    }
                    
                    resolve(success);
                }, 1500);
            });
        }
        
        // 开始群组检测
        function startGroupDetection(groupId) {
            const groupIndex = groups.findIndex(g => g.id === groupId);
            if (groupIndex === -1) return;
            
            const group = groups[groupIndex];
            
            if (group.urls.length === 0) {
                addLog(`群组 ${group.name} 没有待检测链接`, "warning");
                return;
            }
            
            isRunning = true;
            currentGroupId = groupId;
            currentUrlIndex = 0;
            currentGroupIndex = groupIndex;
            
            document.getElementById('startAllBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('testSelectedBtn').disabled = true;
            document.getElementById('testSendBtn').disabled = true;
            
            addLog(`开始检测群组: ${group.name}`, "info");
            
            // 加载群组绑定的网站
            loadUrlInIframe(group.website);
            
            setTimeout(() => {
                processNextUrl();
            }, 3000);
        }
        
        // 测试选中群组
        function testSelectedGroup() {
            const expandedGroup = groups.find(g => g.expanded && g.urls.length > 0);
            if (!expandedGroup) {
                addLog("请先展开一个有链接的群组", "warning");
                return;
            }
            
            startGroupDetection(expandedGroup.id);
        }
        
        // 测试单个URL
        function testSingleUrl(groupId, urlIndex) {
            const group = groups.find(g => g.id === groupId);
            if (!group || urlIndex < 0 || urlIndex >= group.urls.length) return;
            
            const url = group.urls[urlIndex];
            addLog(`测试单个URL: ${getShortUrl(url)}`, "info");
            
            // 加载群组网站
            loadUrlInIframe(group.website);
            
            setTimeout(() => {
                addLog(`使用群组 ${group.name} 的绑定网站进行测试`, "info");
            }, 2000);
        }
        
        // 测试机器人连接
        function testBotConnection() {
            const token = document.getElementById('botToken').value.trim();
            if (!token || token === 'YOUR_BOT_TOKEN_HERE') {
                addLog("请输入有效的Bot Token", "error");
                return;
            }
            
            addLog("测试机器人连接...", "info");
            
            setTimeout(() => {
                const success = Math.random() > 0.2;
                
                if (success) {
                    addLog("✓ 机器人连接测试成功", "success");
                    botToken = token;
                } else {
                    addLog("✗ 机器人连接测试失败", "error");
                }
            }, 1500);
        }
        
        // 停止检测
        function stopDetection() {
            isRunning = false;
            
            document.getElementById('startAllBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('testSelectedBtn').disabled = false;
            document.getElementById('testSendBtn').disabled = false;
            
            addLog("检测已停止", "warning");
        }
        
        // 刷新浏览器
        function refreshBrowser() {
            const url = browserIframe.src;
            if (url && url !== 'about:blank') {
                addLog("刷新页面: " + getShortUrl(url), "info");
                browserIframe.contentWindow.location.reload();
            }
        }
        
        // 在iframe中加载URL
        function loadUrlInIframe(url) {
            if (!url) return;
            currentUrlEl.value = url;
            
            try {
                // 使用代理解决跨域问题
                const proxyUrl = getProxyUrl(url);
                browserIframe.src = proxyUrl;
                addLog(`加载: ${getShortUrl(url)}`, "info");
            } catch (error) {
                browserIframe.src = url;
            }
        }
        
        // 获取代理URL
        function getProxyUrl(url) {
            if (url.includes('baidu.com') || url.includes('google.com')) {
                return url;
            }
            
            const proxyList = [
                'https://cors-anywhere.herokuapp.com/',
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://corsproxy.io/?'
            ];
            
            const proxy = proxyList[Math.floor(Math.random() * proxyList.length)];
            return proxy + encodeURIComponent(url);
        }
        
        // 从URL中提取参数值
        function extractParamFromUrl(url, paramName) {
            try {
                const urlObj = new URL(url);
                return urlObj.searchParams.get(paramName);
            } catch (error) {
                const regex = new RegExp(`[?&]${paramName}=([^&]+)`);
                const match = url.match(regex);
                return match ? match[1] : null;
            }
        }
        
        // 获取短URL（用于显示）
        function getShortUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname + urlObj.pathname.substring(0, 20) + (urlObj.pathname.length > 20 ? '...' : '');
            } catch {
                return url.length > 30 ? url.substring(0, 30) + '...' : url;
            }
        }
        
        // 比较URL是否等效
        function urlsAreEquivalent(url1, url2) {
            try {
                const normalize = (url) => {
                    return url.replace(/^https?:\/\//, '').replace(/^www\./, '').split('#')[0].split('?')[0];
                };
                return normalize(url1) === normalize(url2);
            } catch (e) {
                return url1 === url2;
            }
        }
        
        // 获取有URL的群组数量
        function getGroupsWithUrls() {
            return groups.filter(g => g.urls.length > 0).length;
        }
        
        // 获取总URL数量
        function getTotalUrls() {
            return groups.reduce((total, group) => total + group.urls.length, 0);
        }
        
        // 添加日志
        function addLog(message, type = "info") {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let typeClass = 'log-info';
            if (type === 'success') typeClass = 'log-success';
            else if (type === 'error') typeClass = 'log-error';
            else if (type === 'warning') typeClass = 'log-warning';
            
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="${typeClass}">${message}</span>
            `;
            
            statusLogEl.appendChild(logEntry);
            statusLogEl.scrollTop = statusLogEl.scrollHeight;
            logEntries.push({time, message, type});
        }
        
        // 验证URL格式
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // 添加快捷键
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshBrowser();
            } else if (e.ctrlKey && e.key === 's' && !isRunning) {
                e.preventDefault();
                startAllDetection();
            } else if (e.ctrlKey && e.key === 'e' && isRunning) {
                e.preventDefault();
                stopDetection();
            }
        });
    </script>
</body>
</html>
